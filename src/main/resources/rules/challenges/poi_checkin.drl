package eu.trentorise.game.model

//list any import classes here.

//declare any global variables here

rule "poiReached_rule"
lock-on-active
when
	Action( $id : id == "poi_reached" )
	InputData( $poi : data["poiName"], $time : data["poiTime"])
	$challenge : ChallengeConcept( modelName == "poiCheckin", isCompleted() != true, $poiState : fields["poiState"],
		$target : fields["poiName"], $startTime : fields["startEvent"], $endTime : fields["endEvent"] )
then
	if ($time == null)
		$time = System.currentTimeMillis();
	if ((Long)$time >= (Long)$startTime && (Long)$time <= (Long)$endTime && ((String)$poi).equals((String)$target)) {
		$challenge.getFields().put("poiState",(Boolean) true);
		update($challenge);
		log("poiReached "+$target);
	}
	else {
		$challenge.getFields().put("poiState",(Boolean) false);
	}
		
end


rule "poiCheckin_rule"
lock-on-active
when
	Action( $id : id == 'checkin' ) 
	InputData( $ci : data['checkinName'], $time : data["checkinTime"])
	$challenge : ChallengeConcept( modelName == "poiCheckin", isCompleted() != true, $eventState : fields["eventState"],
		$target : fields["eventName"], $startTime : fields["startEvent"], $endTime : fields["endEvent"] )	
then
	if ($time == null)
		$time = System.currentTimeMillis();
	 if ((Long)$time >= (Long)$startTime && (Long)$time <= (Long)$endTime && ((String)$ci).equals((String)$target)) {
		$challenge.getFields().put("eventState",(Boolean) true);
		update($challenge);
		log("poiCheckin "+$target);		
	}
	else {
		$challenge.getFields().put("eventState",(Boolean) false);
	}
end


rule "ch_poiCheckin_check"
lock-on-active
when
	$challenge : ChallengeConcept( modelName == "poiCheckin", isCompleted() != true, 
		$poiState : fields["poiState"], $eventState : fields["eventState"],
		$bonusPointType : fields["bonusPointType"], $bonusScore : fields["bonusScore"] )
	$pc : PointConcept(name == (String) $bonusPointType)
then
	if ((Boolean)$poiState && (Boolean)$eventState) {
		log('poiCheckin COMPLETED');
		$challenge.completed();
		$pc.setScore($pc.getScore() + (Double) $bonusScore);
		update($pc);
		update($challenge);
	}
end
	
